services:
  # PostgreSQL Master
  postgres:
    image: postgres:16-alpine
    container_name: podiogo-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-podiogo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-podiogo123}
      POSTGRES_DB: ${POSTGRES_DB:-podiogo}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-podiogo}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    # Configurações para permitir replicação
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
      -c archive_mode=on
      -c archive_command=''

  # PostgreSQL Read Replica (habilitado para testes)
  # Para testes, este é um banco separado que simula um read replica
  # Em produção, configure replicação real via streaming replication
  postgres-replica:
    image: postgres:16-alpine
    container_name: podiogo-postgres-replica
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-podiogo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-podiogo123}
      POSTGRES_DB: ${POSTGRES_DB:-podiogo}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_REPLICA_PORT:-5433}:5432"
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-podiogo}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    container_name: podiogo-redis
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
      - ./docker/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "podiogo123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Aplicação NestJS - Instância 1
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: podiogo-app-1
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3333}
      INSTANCE_ID: 1
      
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-podiogo}:${POSTGRES_PASSWORD:-podiogo123}@postgres:5432/${POSTGRES_DB:-podiogo}?schema=public&connection_limit=20&pool_timeout=20
      DATABASE_READ_REPLICA_URL: postgresql://${POSTGRES_USER:-podiogo}:${POSTGRES_PASSWORD:-podiogo123}@postgres-replica:5432/${POSTGRES_DB:-podiogo}?schema=public&connection_limit=10&pool_timeout=20
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-podiogo123}
      REDIS_DB: 0
      REDIS_ENABLED: "true"
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-1h}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-${JWT_SECRET:-change-me-in-production}}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      
      # Session
      SESSION_SECRET: ${SESSION_SECRET:-change-me-in-production}
      
      # Sentry (opcional)
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_ENABLED: ${SENTRY_ENABLED:-false}
      
      # CDN (opcional)
      CDN_URL: ${CDN_URL:-}
      CDN_ENABLED: ${CDN_ENABLED:-false}
      
      # Cielo Payment Gateway
      CIELO_MERCHANT_ID: ${CIELO_MERCHANT_ID:-}
      CIELO_MERCHANT_KEY: ${CIELO_MERCHANT_KEY:-}
      CIELO_ENVIRONMENT: ${CIELO_ENVIRONMENT:-sandbox}
      
      # Email (Nodemailer)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@podiogo.com}
      
      # WhatsApp (opcional)
      WHATSAPP_API_URL: ${WHATSAPP_API_URL:-}
      WHATSAPP_API_KEY: ${WHATSAPP_API_KEY:-}
      
      # Frontend URL
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "3333:3333"
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - ./uploads:/usr/src/app/uploads
      - ./logs:/usr/src/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      postgres-replica:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3333/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Aplicação NestJS - Instância 2 (para load balancing)
  app-2:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: podiogo-app-2
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3333}
      INSTANCE_ID: 2
      
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-podiogo}:${POSTGRES_PASSWORD:-podiogo123}@postgres:5432/${POSTGRES_DB:-podiogo}?schema=public&connection_limit=20&pool_timeout=20
      DATABASE_READ_REPLICA_URL: postgresql://${POSTGRES_USER:-podiogo}:${POSTGRES_PASSWORD:-podiogo123}@postgres-replica:5432/${POSTGRES_DB:-podiogo}?schema=public&connection_limit=10&pool_timeout=20
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-podiogo123}
      REDIS_DB: 0
      REDIS_ENABLED: "true"
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-1h}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-${JWT_SECRET:-change-me-in-production}}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      
      # Session
      SESSION_SECRET: ${SESSION_SECRET:-change-me-in-production}
      
      # Sentry
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_ENABLED: ${SENTRY_ENABLED:-false}
      
      # CDN
      CDN_URL: ${CDN_URL:-}
      CDN_ENABLED: ${CDN_ENABLED:-false}
      
      # Cielo
      CIELO_MERCHANT_ID: ${CIELO_MERCHANT_ID:-}
      CIELO_MERCHANT_KEY: ${CIELO_MERCHANT_KEY:-}
      CIELO_ENVIRONMENT: ${CIELO_ENVIRONMENT:-sandbox}
      
      # Email
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@podiogo.com}
      
      # WhatsApp
      WHATSAPP_API_URL: ${WHATSAPP_API_URL:-}
      WHATSAPP_API_KEY: ${WHATSAPP_API_KEY:-}
      
      # Frontend
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "3334:3333"
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - ./uploads:/usr/src/app/uploads
      - ./logs:/usr/src/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      postgres-replica:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3333/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Aplicação NestJS - Instância 3 (para load balancing)
  app-3:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: podiogo-app-3
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3333}
      INSTANCE_ID: 3
      
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-podiogo}:${POSTGRES_PASSWORD:-podiogo123}@postgres:5432/${POSTGRES_DB:-podiogo}?schema=public&connection_limit=20&pool_timeout=20
      DATABASE_READ_REPLICA_URL: postgresql://${POSTGRES_USER:-podiogo}:${POSTGRES_PASSWORD:-podiogo123}@postgres-replica:5432/${POSTGRES_DB:-podiogo}?schema=public&connection_limit=10&pool_timeout=20
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-podiogo123}
      REDIS_DB: 0
      REDIS_ENABLED: "true"
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-1h}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-${JWT_SECRET:-change-me-in-production}}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      
      # Session
      SESSION_SECRET: ${SESSION_SECRET:-change-me-in-production}
      
      # Sentry
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_ENABLED: ${SENTRY_ENABLED:-false}
      
      # CDN
      CDN_URL: ${CDN_URL:-}
      CDN_ENABLED: ${CDN_ENABLED:-false}
      
      # Cielo
      CIELO_MERCHANT_ID: ${CIELO_MERCHANT_ID:-}
      CIELO_MERCHANT_KEY: ${CIELO_MERCHANT_KEY:-}
      CIELO_ENVIRONMENT: ${CIELO_ENVIRONMENT:-sandbox}
      
      # Email
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@podiogo.com}
      
      # WhatsApp
      WHATSAPP_API_URL: ${WHATSAPP_API_URL:-}
      WHATSAPP_API_KEY: ${WHATSAPP_API_KEY:-}
      
      # Frontend
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "3335:3333"
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - ./uploads:/usr/src/app/uploads
      - ./logs:/usr/src/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      postgres-replica:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3333/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: podiogo-nginx
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./uploads:/var/www/podiogo/uploads:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      app:
        condition: service_healthy
      app-2:
        condition: service_healthy
      app-3:
        condition: service_healthy
    networks:
      - podiogo-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  postgres_replica_data:
    driver: local
  redis_data:
    driver: local

networks:
  podiogo-network:
    driver: bridge


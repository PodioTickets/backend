name: Deploy to Server

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Deploy via SSH
      # IMPORTANTE: Se a autentica√ß√£o falhar, verifique:
      # 1. A chave privada no GitHub Secret SSH_PRIVATE_KEY deve ser a mesma que gerou github_actions.pub
      #    Para verificar: ssh-keygen -y -f ~/.ssh/github_actions (deve mostrar a mesma chave p√∫blica)
      # 2. SSH_PRIVATE_KEY deve incluir TODAS as linhas, incluindo:
      #    -----BEGIN OPENSSH PRIVATE KEY----- (ou -----BEGIN RSA PRIVATE KEY-----)
      #    [todo o conte√∫do da chave]
      #    -----END OPENSSH PRIVATE KEY----- (ou -----END RSA PRIVATE KEY-----)
      # 3. No servidor, verifique: cat ~/.ssh/authorized_keys | grep github_actions
      # 4. Teste local: ssh -i ~/.ssh/github_actions root@IP_DA_VPS
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          script_stop: true
          debug: true
          use_insecure_cipher: false
          script: |
            set -e

            echo "üöÄ Iniciando deploy..."
            cd .. && cd /srv/backend

            echo "üì• Atualizando c√≥digo (${GITHUB_REF_NAME})..."
            git fetch origin
            git checkout ${GITHUB_REF_NAME}
            git pull origin ${GITHUB_REF_NAME}

            echo "üóÑÔ∏è Verificando PostgreSQL..."
            if ! docker compose ps postgres | grep -q "Up"; then
              docker compose up -d postgres
              echo "‚è≥ Aguardando PostgreSQL..."
              sleep 15
            fi

            echo "üîÑ Executando migra√ß√µes..."
            DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public"

            docker run --rm \
              -v "$(pwd):/app" \
              -w /app \
              --network podiogo_podiogo-network \
              -e DATABASE_URL="$DATABASE_URL" \
              node:20-alpine sh -c "
                npm install -g pnpm &&
                pnpm install --frozen-lockfile &&
                pnpm prisma migrate deploy
              " || echo "‚ö†Ô∏è Migra√ß√µes falharam, continuando..."

            echo "üî® Build backend..."
            docker compose build backend

            echo "üîÑ Subindo containers..."
            docker compose up -d backend

            sleep 5

            echo "üè• Verificando status..."
            docker compose ps backend

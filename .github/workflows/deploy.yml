name: Deploy to Server

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          timeout: 60s
          script_stop: true
          script: |
            set -e

            echo "üöÄ Iniciando deploy..."
            cd .. && cd /srv/backend

            echo "üì• Atualizando c√≥digo (${GITHUB_REF_NAME})..."
            git fetch origin
            git checkout ${GITHUB_REF_NAME}
            git pull origin ${GITHUB_REF_NAME}

            echo "üóÑÔ∏è Verificando PostgreSQL..."
            if ! docker compose ps postgres | grep -q "Up"; then
              docker compose up -d postgres
              echo "‚è≥ Aguardando PostgreSQL..."
              sleep 15
            fi

            echo "üîÑ Executando migra√ß√µes..."
            DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public"

            docker run --rm \
              -v "$(pwd):/app" \
              -w /app \
              --network podiogo_podiogo-network \
              -e DATABASE_URL="$DATABASE_URL" \
              node:20-alpine sh -c "
                npm install -g pnpm &&
                pnpm install --frozen-lockfile &&
                pnpm prisma migrate deploy
              " || echo "‚ö†Ô∏è Migra√ß√µes falharam, continuando..."

            echo "üî® Build backend..."
            docker compose build backend

            echo "üîÑ Subindo containers..."
            docker compose up -d backend

            sleep 5

            echo "üè• Verificando status..."
            docker compose ps backend

name: Deploy to Server

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Validate SSH Key Format
        run: |
          echo "üîç Validando formato da chave SSH..."
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY n√£o est√° configurado!"
            exit 1
          fi
          echo "‚úÖ SSH_PRIVATE_KEY est√° configurado"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          script_stop: true
          debug: true
          use_insecure_cipher: false
          script: |
            set -e

            echo "Iniciando deploy..."
            cd .. && cd /srv/backend

            echo "Atualizando c√≥digo"
            git fetch origin
            git pull origin ${GITHUB_REF_NAME}

            echo "Executando migra√ß√µes..."
            DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public"

            docker run --rm \
              -v "$(pwd):/app" \
              -w /app \
              --network podiogo_podiogo-network \
              -e DATABASE_URL="$DATABASE_URL" \
              node:20-alpine sh -c "
                npm install -g pnpm &&
                pnpm install --frozen-lockfile &&
                pnpm prisma migrate deploy
              " || echo "‚ö†Ô∏è Migra√ß√µes falharam, continuando..."

            echo "üî® Build backend..."
            docker compose build backend

            echo "üîÑ Subindo containers..."
            docker compose up -d backend

            sleep 5

            echo "üè• Verificando status..."
            docker compose ps backend
